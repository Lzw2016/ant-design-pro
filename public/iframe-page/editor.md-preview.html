<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8" />
  <title>editor.md</title>
  <link rel="stylesheet" href="editor.md/css/editormd.min.css" />
  <link rel="stylesheet" href="editor.md-preview.css" />
</head>

<body>
  <div class="page">
    <!-- 页面头部 -->
    <div class="header">
      <span class="headerDivFirst">
        <span id="title">
          <!--文章标题-->
        </span>
      </span>
      <span class="headerDivLast">
        <span id="createBy">
          <!--作者-->
        </span>
        <span id="createDate">
          <!--创建时间-->
        </span>
        <span id="updateBy">
          <!--更新人-->
        </span>
        <span id="updateDate">
          <!--最后更新时间-->
        </span>
        <span id="numberOfWords">
          <!--字数-->
        </span>
      </span>
    </div>

    <!-- 文档内容 -->
    <div id="editormd" class="content">
      <textarea style="display:none;"></textarea>
    </div>

    <!-- 文档菜单 -->
    <div id="custom-toc-container" class="menu"></div>
  </div>
</body>

<script type="text/javascript" src="jquery/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="editor.md/editormd.min.js"></script>
<script type="text/javascript" src="editor.md/editormd.min.js"></script>
<script type="text/javascript" src="editor.md/lib/marked.min.js"></script>
<script type="text/javascript" src="editor.md/lib/prettify.min.js"></script>
<script type="text/javascript" src="editor.md/lib/raphael.min.js"></script>
<script type="text/javascript" src="editor.md/lib/underscore.min.js"></script>
<script type="text/javascript" src="editor.md/lib/sequence-diagram.min.js"></script>
<script type="text/javascript" src="editor.md/lib/flowchart.min.js"></script>
<script type="text/javascript" src="editor.md/lib/jquery.flowchart.min.js"></script>
<script type="text/javascript">
  // Emoji's 图片地址
  var emojiPath = "/Image/emoji/";
  // Twitter Emoji 图片地址
  var twemojiPath = "/Image/twemoji/72x72/";
  // katexJsUrl
  var katexJsUrl = "/KaTeX/katex.min";
  // katexCssUrl
  var katexCssUrl = "/KaTeX/katex.min";
  // 编辑器显示对象
  var editormdView = null;
  // 文档信息
  var documentInfo = null;
  // 文章标题
  var title = $("#title");
  // 作者
  var createBy = $("#createBy");
  // 创建时间
  var createDate = $("#createDate");
  // 更新人
  var updateBy = $("#updateBy");
  // 最后更新时间
  var updateDate = $("#updateDate");
  // 字数
  var numberOfWords = $("#numberOfWords");

  // You can custom Emoji's graphics files url path
  // editormd.emoji = { path: emojiPath, ext: ".png" };
  // Twitter Emoji (Twemoji)  graphics files url path
  // editormd.twemoji = { path: twemojiPath, ext: ".png" };
  // KaTeX
  // editormd.katexURL = { js: katexJsUrl, css: katexCssUrl };

  // 初始化页面
  function initEditormdView(docInfo) {
    documentInfo = docInfo;
    var markdownContent = docInfo.content;
    if ($.trim(markdownContent) === "") {
      markdownContent = "空文档!";
    }
    setHeader(docInfo);
    editormdView = editormd.markdownToHTML("editormd", {
      markdown: markdownContent,
      //htmlDecode      : true,               // 开启 HTML 标签解析(为了安全性)，默认不开启
      htmlDecode: "style,script,iframe",      // you can filter tags decode
      //toc             : false,
      tocm: true,    // Using [TOCM]
      tocContainer: "#custom-toc-container", // 自定义 ToC 容器层
      //gfm             : false,
      //tocDropdown     : true,
      // markdownSourceCode : true, // 是否保留 Markdown 源码，即是否删除保存源码的 Textarea 标签
      emoji: true,
      taskList: true,
      tex: true,                // 默认不解析
      flowChart: true,          // 默认不解析
      sequenceDiagram: true     // 默认不解析
    });
    // anchorLinkOffset();
  }

  // 设置页头信息
  function setHeader(docInfo) {
    if (docInfo == null) {
      return;
    }
    title.text(docInfo.title);
    createBy.text("作者:" + docInfo.createBy);
    createDate.text("创建时间:" + docInfo.createDate);
    if (docInfo.updateBy) {
      updateBy.text("更新人:" + docInfo.updateBy);
    } else {
      updateBy.text("");
    }
    if (docInfo.updateDate) {
      updateDate.text("最后更新时间:" + docInfo.updateDate);
    } else {
      updateDate.text("");
    }
    if (docInfo.content) {
      numberOfWords.text("字数:" + docInfo.content.length);
    } else {
      numberOfWords.text("");
    }
  }

  // 锚点链接的偏移问题
  function anchorLinkOffset() {
    var handler = function (hash) {
      var target = $(".content a[name='" + hash.slice(1) + "']");
      if (target.length == 1) {
        var top = target.offset().top - 50;
        if (top > 0) {
          $('html,body').animate({ scrollTop: top }, 500);
        }
      }
    };
    $(".menu a[href^='#'][href!='#']").click(function () {
      handler(this.hash);
      history.pushState({}, '', this.href);
      return false;
    });
    if (location.hash) {
      handler(location.hash);
    }
  };

  $.ajax({
    type: "GET",
    url: "demo.md",
    async: true,
    success: function (data) {
      initEditormdView({
        content: data,
        title: "测试预览功能",
        createBy: "lizw",
        createDate: "2019-07-16 18:00:00",
        updateBy: "lizw",
        updateDate: "2019-07-16 18:00:00",
      });
    }
  });
</script>

</html>
